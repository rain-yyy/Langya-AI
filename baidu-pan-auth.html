<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾åº¦ç½‘ç›˜æˆæƒç¤ºä¾‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        button {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0b7dda;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .config-section {
            background-color: #f5f5f5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .config-section input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .file-item strong {
            color: #2196F3;
        }
        .token-info {
            background-color: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            word-break: break-all;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç™¾åº¦ç½‘ç›˜æˆæƒç¤ºä¾‹</h1>
        
        <div class="config-section">
            <h3>é…ç½®ä¿¡æ¯</h3>
            <p><strong>è¯´æ˜ï¼š</strong>åº”ç”¨å·²é…ç½®ï¼Œè¯·ç¡®è®¤å›è°ƒåœ°å€å’ŒCORSä»£ç†åç‚¹å‡»ä¿å­˜ã€‚</p>
            <label>
                <strong>App Key:</strong>
                <input type="text" id="appKey" value="AQoN4IEJyNj71Sp51rl3378udvSuknBu" readonly style="background-color: #e9ecef;">
            </label>
            <label>
                <strong>æˆæƒå›è°ƒåœ°å€:</strong>
                <input type="text" id="redirectUri" placeholder="è‡ªåŠ¨æ£€æµ‹å½“å‰é¡µé¢URL">
            </label>
            <label>
                <strong>CORSä»£ç†åœ°å€:</strong>
                <input type="text" id="proxyUrl" placeholder="ä¾‹å¦‚ï¼šhttps://your-worker.workers.dev/?url=">
            </label>
            <p style="color: #666; font-size: 14px;">
                âš ï¸ <strong>é‡è¦é…ç½®ï¼š</strong><br>
                1. <strong>å›è°ƒåœ°å€ï¼š</strong>è¯·åœ¨<a href="https://pan.baidu.com/union/console/applist" target="_blank">ç™¾åº¦ç½‘ç›˜å¼€æ”¾å¹³å°</a>çš„åº”ç”¨è®¾ç½®ä¸­é…ç½®ç›¸åŒçš„å›è°ƒåœ°å€ã€‚<br>
                2. <strong>CORSä»£ç†ï¼š</strong>éœ€è¦éƒ¨ç½²Cloudflare Workeræ¥è§£å†³è·¨åŸŸé—®é¢˜ï¼Œè¯¦è§ä¸‹æ–¹è¯´æ˜ã€‚<br>
                ğŸ“ å›è°ƒåœ°å€æ ¼å¼ï¼š<code>https://your-domain.pages.dev/baidu-pan-auth.html</code><br>
                ğŸ“ ä»£ç†åœ°å€æ ¼å¼ï¼š<code>https://your-worker.workers.dev/?url=</code>ï¼ˆæ³¨æ„æœ«å°¾çš„ <code>?url=</code>ï¼‰
            </p>
            <button onclick="autoDetectAndSave()">è‡ªåŠ¨æ£€æµ‹å¹¶ä¿å­˜</button>
            <button onclick="saveConfig()">æ‰‹åŠ¨ä¿å­˜é…ç½®</button>
        </div>

        <div id="statusDiv"></div>
        <div id="tokenDiv"></div>

        <div>
            <h3>æ“ä½œ</h3>
            <button id="authBtn" onclick="startAuth()">1. ç‚¹å‡»æˆæƒ</button>
            <button id="getUserBtn" onclick="getUserInfo()" disabled>2. è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button id="getFilesBtn" onclick="getFileList()" disabled>3. è·å–æ–‡ä»¶åˆ—è¡¨</button>
            <button onclick="clearToken()">æ¸…é™¤æˆæƒ</button>
        </div>

        <div id="fileList" class="file-list"></div>

        <!-- CORSä»£ç†é…ç½®è¯´æ˜ -->
        <div class="config-section" style="margin-top: 30px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <h3>ğŸ”§ CORSä»£ç†é…ç½®è¯´æ˜</h3>
            <p><strong>ä¸ºä»€ä¹ˆéœ€è¦CORSä»£ç†ï¼Ÿ</strong></p>
            <p>ç™¾åº¦ç½‘ç›˜APIä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è·¨åŸŸè®¿é—®ã€‚ä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªCloudflare Workerä½œä¸ºä»£ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
            
            <h4>ğŸ“‹ å¿«é€Ÿé…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰ï¼š</h4>
            <ol style="line-height: 1.8;">
                <li><strong>åˆ›å»ºWorkerï¼š</strong>è®¿é—® <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a> â†’ Workers & Pages â†’ Create Worker</li>
                <li><strong>å‘½åWorkerï¼š</strong>ä¾‹å¦‚ <code>baidu-pan-proxy</code></li>
                <li><strong>ç¼–è¾‘ä»£ç ï¼š</strong>ç‚¹å‡» "Edit code"ï¼Œå°†é¡¹ç›®ä¸­çš„ <code>worker.js</code> æ–‡ä»¶å†…å®¹å¤åˆ¶ç²˜è´´è¿›å»</li>
                <li><strong>éƒ¨ç½²ï¼š</strong>ç‚¹å‡» "Save and Deploy"</li>
                <li><strong>è·å–URLï¼š</strong>ä¾‹å¦‚ <code>https://baidu-pan-proxy.xxx.workers.dev</code></li>
                <li><strong>é…ç½®é¡µé¢ï¼š</strong>åœ¨ä¸Šæ–¹"CORSä»£ç†åœ°å€"è¾“å…¥æ¡†å¡«å…¥ï¼š<code>https://baidu-pan-proxy.xxx.workers.dev/?url=</code> <strong>(æ³¨æ„æœ«å°¾çš„ ?url=)</strong></li>
            </ol>
            
            <p style="margin-top: 15px;">
                ğŸ“– <strong>è¯¦ç»†æ•™ç¨‹ï¼š</strong>
                <a href="https://github.com/ä½ çš„ç”¨æˆ·å/Langya-AI/blob/main/CORS-SOLUTION.md" target="_blank">CORS-SOLUTION.md</a> | 
                <a href="https://github.com/ä½ çš„ç”¨æˆ·å/Langya-AI/blob/main/WORKER-SETUP.md" target="_blank">WORKER-SETUP.md</a>
            </p>
            
            <p style="margin-top: 10px; color: #856404;">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>Cloudflare Workers å…è´¹å¥—é¤æ¯å¤©æœ‰ 100,000 æ¬¡è¯·æ±‚é¢åº¦ï¼Œå®Œå…¨å¤Ÿç”¨ï¼
            </p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let accessToken = null;
        let appKey = 'AQoN4IEJyNj71Sp51rl3378udvSuknBu'; // é¢„é…ç½®çš„AppKey
        let redirectUri = 'https://langya-ai.pages.dev/baidu-pan-auth.html';
        // CORSä»£ç†URL - éƒ¨ç½²Workeråéœ€è¦æ›´æ–°æ­¤URL
        let proxyUrl = 'https://your-worker-name.your-subdomain.workers.dev/?url=';

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            // è‡ªåŠ¨æ£€æµ‹å½“å‰URL
            autoDetectRedirectUri();
            
            // åŠ è½½ä¿å­˜çš„é…ç½®
            loadConfig();
            
            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰access_tokenï¼ˆæˆæƒå›è°ƒï¼‰
            checkAuthCallback();
        };

        // è‡ªåŠ¨æ£€æµ‹å›è°ƒåœ°å€
        function autoDetectRedirectUri() {
            const currentUrl = window.location.origin + window.location.pathname;
            document.getElementById('redirectUri').value = currentUrl;
            document.getElementById('redirectUri').placeholder = currentUrl;
        }

        // è‡ªåŠ¨æ£€æµ‹å¹¶ä¿å­˜
        function autoDetectAndSave() {
            autoDetectRedirectUri();
            redirectUri = document.getElementById('redirectUri').value;
            proxyUrl = document.getElementById('proxyUrl').value;
            
            if (!redirectUri) {
                showStatus('æ— æ³•æ£€æµ‹åˆ°æœ‰æ•ˆçš„URL', 'error');
                return;
            }
            
            if (!proxyUrl || proxyUrl === 'https://your-worker-name.your-subdomain.workers.dev/?url=') {
                showStatus('âš ï¸ è¯·å…ˆéƒ¨ç½²Cloudflare Workerå¹¶é…ç½®CORSä»£ç†åœ°å€ï¼è¯¦è§ä¸‹æ–¹è¯´æ˜ã€‚', 'error');
                return;
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('baidu_pan_app_key', appKey);
            localStorage.setItem('baidu_pan_redirect_uri', redirectUri);
            localStorage.setItem('baidu_pan_proxy_url', proxyUrl);
            
            showStatus('é…ç½®å·²ä¿å­˜ï¼å›è°ƒåœ°å€: ' + redirectUri, 'success');
            document.getElementById('authBtn').disabled = false;
            
            // æç¤ºç”¨æˆ·åœ¨ç™¾åº¦å¼€æ”¾å¹³å°é…ç½®
            setTimeout(() => {
                showStatus('âœ… é…ç½®å·²ä¿å­˜ï¼<br>ğŸ“Œ <strong>ä¸‹ä¸€æ­¥ï¼š</strong>è¯·å‰å¾€<a href="https://pan.baidu.com/union/console/applist" target="_blank" style="color: #0056b3;">ç™¾åº¦ç½‘ç›˜å¼€æ”¾å¹³å°</a>ï¼Œåœ¨åº”ç”¨è®¾ç½®ä¸­é…ç½®å›è°ƒåœ°å€ï¼š<br><code style="background: #fff; padding: 5px; display: inline-block; margin-top: 5px;">' + redirectUri + '</code>', 'info');
            }, 2000);
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            appKey = document.getElementById('appKey').value.trim();
            redirectUri = document.getElementById('redirectUri').value.trim();
            proxyUrl = document.getElementById('proxyUrl').value.trim();
            
            if (!appKey || !redirectUri) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            if (!proxyUrl) {
                showStatus('âš ï¸ è¯·é…ç½®CORSä»£ç†åœ°å€ï¼è¯¦è§ä¸‹æ–¹è¯´æ˜ã€‚', 'error');
                return;
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('baidu_pan_app_key', appKey);
            localStorage.setItem('baidu_pan_redirect_uri', redirectUri);
            localStorage.setItem('baidu_pan_proxy_url', proxyUrl);
            
            showStatus('é…ç½®å·²ä¿å­˜', 'success');
            document.getElementById('authBtn').disabled = false;
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const savedAppKey = localStorage.getItem('baidu_pan_app_key');
            const savedRedirectUri = localStorage.getItem('baidu_pan_redirect_uri');
            const savedProxyUrl = localStorage.getItem('baidu_pan_proxy_url');
            const savedToken = localStorage.getItem('baidu_pan_access_token');
            
            if (savedAppKey) {
                document.getElementById('appKey').value = savedAppKey;
                appKey = savedAppKey;
            }
            
            if (savedRedirectUri) {
                document.getElementById('redirectUri').value = savedRedirectUri;
                redirectUri = savedRedirectUri;
            }
            
            if (savedProxyUrl) {
                document.getElementById('proxyUrl').value = savedProxyUrl;
                proxyUrl = savedProxyUrl;
            }
            
            if (savedToken) {
                accessToken = savedToken;
                showStatus('å·²æ£€æµ‹åˆ°ä¿å­˜çš„Access Token', 'success');
                showToken(accessToken);
                enableButtons();
            }
            
            if (appKey && redirectUri && proxyUrl) {
                document.getElementById('authBtn').disabled = false;
            }
        }

        // æ£€æŸ¥æˆæƒå›è°ƒ
        function checkAuthCallback() {
            const hash = window.location.hash;
            
            if (hash.includes('access_token=')) {
                // è§£æhashä¸­çš„å‚æ•°
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');
                
                if (accessToken) {
                    // ä¿å­˜token
                    localStorage.setItem('baidu_pan_access_token', accessToken);
                    
                    showStatus('æˆæƒæˆåŠŸï¼Access Token å·²è·å–ï¼Œæœ‰æ•ˆæœŸ: ' + expiresIn + 'ç§’ï¼ˆ30å¤©ï¼‰', 'success');
                    showToken(accessToken);
                    enableButtons();
                    
                    // æ¸…é™¤URLä¸­çš„hash
                    history.replaceState(null, null, window.location.pathname);
                }
            }
        }

        // å¼€å§‹æˆæƒ
        function startAuth() {
            if (!appKey || !redirectUri) {
                showStatus('è¯·å…ˆé…ç½®å¹¶ä¿å­˜ App Key å’Œå›è°ƒåœ°å€', 'error');
                return;
            }
            
            // æ„é€ æˆæƒURLï¼ˆç®€åŒ–æ¨¡å¼ï¼‰
            const authUrl = 'http://openapi.baidu.com/oauth/2.0/authorize?' +
                'response_type=token&' +
                'client_id=' + encodeURIComponent(appKey) + '&' +
                'redirect_uri=' + encodeURIComponent(redirectUri) + '&' +
                'scope=basic,netdisk&' +
                'display=page';
            
            showStatus('æ­£åœ¨è·³è½¬åˆ°ç™¾åº¦æˆæƒé¡µé¢...', 'info');
            
            // è·³è½¬åˆ°æˆæƒé¡µé¢
            window.location.href = authUrl;
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function getUserInfo() {
            if (!accessToken) {
                showStatus('è¯·å…ˆè¿›è¡Œæˆæƒ', 'error');
                return;
            }
            
            try {
                showStatus('æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...', 'info');
                
                // æ„é€ ç™¾åº¦APIçš„å®Œæ•´URL
                const baiduApiUrl = 'https://pan.baidu.com/rest/2.0/xpan/nas?method=uinfo&access_token=' + accessToken;
                
                // é€šè¿‡CORSä»£ç†è®¿é—®
                const response = await fetch(proxyUrl + encodeURIComponent(baiduApiUrl));
                
                const data = await response.json();
                
                if (data.errno === 0) {
                    showStatus('ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    displayUserInfo(data);
                } else {
                    showStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (data.errmsg || data.errno), 'error');
                }
            } catch (error) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function getFileList() {
            if (!accessToken) {
                showStatus('è¯·å…ˆè¿›è¡Œæˆæƒ', 'error');
                return;
            }
            
            try {
                showStatus('æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...', 'info');
                
                // æ„é€ ç™¾åº¦APIçš„å®Œæ•´URL - è·å–æ ¹ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨
                const baiduApiUrl = 'https://pan.baidu.com/rest/2.0/xpan/file?method=list&dir=/&access_token=' + accessToken;
                
                // é€šè¿‡CORSä»£ç†è®¿é—®
                const response = await fetch(proxyUrl + encodeURIComponent(baiduApiUrl));
                
                const data = await response.json();
                
                if (data.errno === 0) {
                    showStatus('æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸï¼Œå…± ' + data.list.length + ' ä¸ªé¡¹ç›®', 'success');
                    displayFileList(data.list);
                } else {
                    showStatus('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + (data.errmsg || data.errno), 'error');
                }
            } catch (error) {
                showStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo(data) {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '<h3>ç”¨æˆ·ä¿¡æ¯</h3>' +
                '<div class="file-item">' +
                '<p><strong>ç™¾åº¦è´¦å·UID:</strong> ' + (data.baidu_name || 'N/A') + '</p>' +
                '<p><strong>ç½‘ç›˜è´¦å·ID:</strong> ' + (data.netdisk_name || 'N/A') + '</p>' +
                '<p><strong>å¤´åƒåœ°å€:</strong> ' + (data.avatar_url || 'N/A') + '</p>' +
                '<p><strong>VIPç±»å‹:</strong> ' + (data.vip_type || 0) + '</p>' +
                '</div>';
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFileList(fileList) {
            const fileListDiv = document.getElementById('fileList');
            
            if (fileList.length === 0) {
                fileListDiv.innerHTML = '<h3>æ–‡ä»¶åˆ—è¡¨</h3><p>æ ¹ç›®å½•ä¸ºç©º</p>';
                return;
            }
            
            let html = '<h3>æ–‡ä»¶åˆ—è¡¨ï¼ˆæ ¹ç›®å½•ï¼‰</h3>';
            
            fileList.forEach(file => {
                const isDir = file.isdir === 1;
                const fileType = isDir ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶';
                const size = isDir ? '-' : formatFileSize(file.size);
                const mtime = new Date(file.server_mtime * 1000).toLocaleString('zh-CN');
                
                html += '<div class="file-item">' +
                    '<p><strong>ğŸ“ åç§°:</strong> ' + file.server_filename + '</p>' +
                    '<p><strong>ç±»å‹:</strong> ' + fileType + '</p>' +
                    '<p><strong>å¤§å°:</strong> ' + size + '</p>' +
                    '<p><strong>è·¯å¾„:</strong> ' + file.path + '</p>' +
                    '<p><strong>ä¿®æ”¹æ—¶é—´:</strong> ' + mtime + '</p>' +
                    '<p><strong>fs_id:</strong> ' + file.fs_id + '</p>' +
                    '</div>';
            });
            
            fileListDiv.innerHTML = html;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
        }

        // æ˜¾ç¤ºTokenä¿¡æ¯
        function showToken(token) {
            const tokenDiv = document.getElementById('tokenDiv');
            const shortToken = token.substring(0, 20) + '...' + token.substring(token.length - 20);
            tokenDiv.innerHTML = '<div class="token-info"><strong>Access Token:</strong> ' + shortToken + '</div>';
        }

        // å¯ç”¨æ“ä½œæŒ‰é’®
        function enableButtons() {
            document.getElementById('getUserBtn').disabled = false;
            document.getElementById('getFilesBtn').disabled = false;
        }

        // æ¸…é™¤æˆæƒ
        function clearToken() {
            accessToken = null;
            localStorage.removeItem('baidu_pan_access_token');
            document.getElementById('tokenDiv').innerHTML = '';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('getUserBtn').disabled = true;
            document.getElementById('getFilesBtn').disabled = true;
            showStatus('æˆæƒå·²æ¸…é™¤', 'info');
        }
    </script>
</body>
</html>

